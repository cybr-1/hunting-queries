
**MITRE ATT&CK**

- Category: Initial Access
- Technique:Â [Exploit Public-Facing Application](https://attack.mitre.org/techniques/T1190)
- Sub Technique: - 
- ID: T1190

---

# Hunting Query / Analytic Rule

## Visualisation of Inbound Traffic to Internet Facing Devices

> [!INFO]
> This is a visualisation query, not all results are malicious, however it can be good to spot anomalies or help drill down on potential issues.

This query will help visualise the Inbound traffic to devices that are facing the net. It will render the data into a Column chart and show the daily  trend over the last X days (Range can be edited on line one of the query). 

```kusto
let timeframe = ago(14d); // Modify this to set how far you want to lookup data.
// Get internet facing devices
let internetFacingDevices = 
    DeviceInfo
    | where Timestamp > timeframe
    | where IsInternetFacing
    | extend InternetFacingInfo = AdditionalFields
    | extend InternetFacingReason = extractjson("$.InternetFacingReason", InternetFacingInfo, typeof(string)), 
             InternetFacingLocalPort = extractjson("$.InternetFacingLocalPort", InternetFacingInfo, typeof(int)), 
             InternetFacingScannedPublicPort = extractjson("$.InternetFacingPublicScannedPort", InternetFacingInfo, typeof(int)), 
             InternetFacingScannedPublicIp = extractjson("$.InternetFacingPublicScannedIp", InternetFacingInfo, typeof(string)), 
             InternetFacingLocalIp = extractjson("$.InternetFacingLocalIp", InternetFacingInfo, typeof(string)),   
             InternetFacingTransportProtocol=extractjson("$.InternetFacingTransportProtocol", InternetFacingInfo, typeof(string)), 
             InternetFacingLastSeen = extractjson("$.InternetFacingLastSeen", InternetFacingInfo, typeof(datetime))
    | project Timestamp, DeviceName, DeviceId, PublicIP, InternetFacingLocalIp, InternetFacingLocalPort
    | summarize arg_max(Timestamp, *) by DeviceId;
// Get all inbound connections to the internet facing devices
let inboundConnections =
    internetFacingDevices
    | join kind=inner (
        DeviceNetworkEvents
        | where Timestamp > timeframe
    ) on DeviceId
    | where LocalPort == InternetFacingLocalPort
    | where ActionType == "InboundConnectionAccepted"
    | extend IPV4Address = iif(RemoteIP startswith "::ffff:", substring(RemoteIP, 7), RemoteIP)
    | project Timestamp = Timestamp1, DeviceName, DestIPPublicIP=PublicIP, DestPort=InternetFacingLocalPort, ActionType, SrcIP=IPV4Address, SrcPort=RemotePort 
    | sort by Timestamp desc;
// Render the data into a column chart to visualise the trend of daily inbound connections over X days 
inboundConnections
| summarize InboundConnectionsCount = count() by bin(Timestamp, 24h), DeviceName
| render columnchart
```

## Inbound Traffic to Internet Facing Devices (Raw)

This query will display the same information as above except rendered as a table with more usable information.

```kusto
let timeframe = ago(24h); // Modify this to set how far you want to lookup data.
// Get internet facing devices
let internetFacingDevices = 
    DeviceInfo
    | where Timestamp > timeframe
    | where IsInternetFacing
    | extend InternetFacingInfo = AdditionalFields
    | extend InternetFacingReason = extractjson("$.InternetFacingReason", InternetFacingInfo, typeof(string)), 
             InternetFacingLocalPort = extractjson("$.InternetFacingLocalPort", InternetFacingInfo, typeof(int)), 
             InternetFacingScannedPublicPort = extractjson("$.InternetFacingPublicScannedPort", InternetFacingInfo, typeof(int)), 
             InternetFacingScannedPublicIp = extractjson("$.InternetFacingPublicScannedIp", InternetFacingInfo, typeof(string)), 
             InternetFacingLocalIp = extractjson("$.InternetFacingLocalIp", InternetFacingInfo, typeof(string)),   
             InternetFacingTransportProtocol=extractjson("$.InternetFacingTransportProtocol", InternetFacingInfo, typeof(string)), 
             InternetFacingLastSeen = extractjson("$.InternetFacingLastSeen", InternetFacingInfo, typeof(datetime))
    | project Timestamp, DeviceName, DeviceId, PublicIP, InternetFacingLocalIp, InternetFacingLocalPort
    | summarize arg_max(Timestamp, *) by DeviceId;
// Get all inbound connections to the internet facing devices
internetFacingDevices
| join kind=inner (
    DeviceNetworkEvents
    | where Timestamp > timeframe
    ) on DeviceId
| where LocalPort == InternetFacingLocalPort
| where ActionType == "InboundConnectionAccepted"
| extend IPV4Address = iif(RemoteIP startswith "::ffff:", substring(RemoteIP, 7), RemoteIP) // This tidies up the output of the SrcIP value
| project Timestamp = Timestamp1, DeviceName, DestIPPublicIP=PublicIP, DestPort=InternetFacingLocalPort, ActionType, SrcIP=IPV4Address, SrcPort=RemotePort 
| sort by Timestamp desc;
```

## Inbound Traffic to Internet Facing Devices (By SrcIP)

This query will look at the count of traffic coming from a single SrcIP, this is good to spot unusual activities, for example it could be bruteforce attempts on a webapp. 

```KQL
let timeframe = ago(7d); // Modify this to set how far you want to lookup data.
// Get internet facing devices
let internetFacingDevices = 
    DeviceInfo
    | where Timestamp > timeframe
    | where IsInternetFacing
    | extend InternetFacingInfo = AdditionalFields
    | extend InternetFacingReason = extractjson("$.InternetFacingReason", InternetFacingInfo, typeof(string)), 
             InternetFacingLocalPort = extractjson("$.InternetFacingLocalPort", InternetFacingInfo, typeof(int)), 
             InternetFacingScannedPublicPort = extractjson("$.InternetFacingPublicScannedPort", InternetFacingInfo, typeof(int)), 
             InternetFacingScannedPublicIp = extractjson("$.InternetFacingPublicScannedIp", InternetFacingInfo, typeof(string)), 
             InternetFacingLocalIp = extractjson("$.InternetFacingLocalIp", InternetFacingInfo, typeof(string)),   
             InternetFacingTransportProtocol=extractjson("$.InternetFacingTransportProtocol", InternetFacingInfo, typeof(string)), 
             InternetFacingLastSeen = extractjson("$.InternetFacingLastSeen", InternetFacingInfo, typeof(datetime))
    | project Timestamp, DeviceName, DeviceId, PublicIP, InternetFacingLocalIp, InternetFacingLocalPort
    | summarize arg_max(Timestamp, *) by DeviceId;
// Get all inbound connections to the internet facing devices
internetFacingDevices
| join kind=inner (
    DeviceNetworkEvents
    | where Timestamp > timeframe
) on DeviceId
| where LocalPort == InternetFacingLocalPort
| where ActionType == "InboundConnectionAccepted"
| extend IPV4Address = iif(RemoteIP startswith "::ffff:", substring(RemoteIP, 7), RemoteIP) // This tidies up the output of the SrcIP value
| project Timestamp = Timestamp1, DeviceName, DestIPPublicIP=PublicIP, DestPort=InternetFacingLocalPort, ActionType, SrcIP=IPV4Address, SrcPort=RemotePort 
| summarize count()by SrcIP, DeviceName
| sort by count_
```
